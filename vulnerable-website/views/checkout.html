<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Checkout - ShopHub</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="container">
            <a href="/" class="logo">ShopHub</a>
            <div class="nav-links">
                <a href="/shop">Shop</a>
                <a href="/orders">My Orders</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="checkout-box">
            <h2>Checkout</h2>
            <form id="checkoutForm">
                <div class="form-group">
                    <label>Product</label>
                    <select id="product_id" name="product_id" required onchange="updatePrice()">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Engraving Colors (Select multiple with Ctrl/Cmd)</label>
                    <select id="engraving_colors" name="engraving_colors" multiple size="4">
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="black">Black</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                    </select>
                    <small style="color: #666; font-size: 0.85rem;">Hold Ctrl/Cmd to select multiple colors</small>
                </div>

                <div class="form-group">
                    <label>Base Price</label>
                    <input type="number" id="base_price" name="base_price" readonly>
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" required>
                </div>

                <div class="form-group">
                    <label>Discount Code</label>
                    <select id="discount_code" name="discount_code">
                        <option value="">No discount</option>
                        <option value="SAVE10">SAVE10 (10% off)</option>
                        <option value="SAVE20">SAVE20 (20% off)</option>
                        <option value="FREESHIP">FREESHIP (Free shipping)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Shipping Method</label>
                    <select id="shipping_method" name="shipping_method">
                        <option value="standard">Standard ($5)</option>
                        <option value="express">Express ($15)</option>
                        <option value="overnight">Overnight ($25)</option>
                    </select>
                </div>

                <button type="submit" class="btn">Place Order</button>
            </form>
        </div>

        <div id="result" style="display: none;">
            <h3>Order Successful!</h3>
            <div id="orderDetails"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const preselectedProductId = urlParams.get('product_id');

        async function loadProducts() {
            const res = await fetch('/products');
            const products = await res.json();
            
            const select = document.getElementById('product_id');
            select.innerHTML = products.map(p => 
                `<option value="${p.id}" ${p.id == preselectedProductId ? 'selected' : ''}>${p.name} - $${p.price.toFixed(2)}</option>`
            ).join('');
            
            if (preselectedProductId) {
                updatePrice();
            }
        }

        function updatePrice() {
            const productId = document.getElementById('product_id').value;
            if (productId) {
                fetch(`/products/${productId}`)
                    .then(res => res.json())
                    .then(product => {
                        document.getElementById('base_price').value = product.price;
                    });
            }
        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (Array.isArray(data[key])) {
                        data[key].push(value);
                    } else {
                        data[key] = [data[key], value];
                    }
                } else {
                    data[key] = value;
                }
            }

            const res = await fetch('/checkout/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(data).toString()
            });

            const result = await res.json();

            if (result.status === 'success') {
                const details = result.order_details;
                
                let engravingHTML = '';
                if (details.engraving_colors && details.engraving_colors.length > 0) {
                    engravingHTML = `<p><strong>Engraving Colors:</strong> ${details.engraving_colors.join(', ')}</p>`;
                }
                
                document.getElementById('orderDetails').innerHTML = `
                    <p><strong>Order ID:</strong> ${details.order_id}</p>
                    <p><strong>Product:</strong> ${details.product_name}</p>
                    ${engravingHTML}
                    <p><strong>Quantity:</strong> ${details.quantity}</p>
                    <p><strong>Subtotal:</strong> $${details.subtotal}</p>
                    ${details.discount_codes.length > 0 ? `<p><strong>Discounts:</strong> ${details.discount_codes.join(', ')}</p>` : ''}
                    ${details.discount_history.length > 0 ? `<div class="discount-history">${details.discount_history.map(h => `<p>${h}</p>`).join('')}</div>` : ''}
                    <p><strong>Shipping:</strong> ${details.shipping_method} ($${details.shipping_cost})</p>
                    <p class="total"><strong>Total:</strong> $${details.final_total}</p>
                    <p><strong>New Balance:</strong> $${details.new_balance}</p>
                `;
                document.getElementById('result').style.display = 'block';
                e.target.style.display = 'none';
            } else {
                alert(result.error || 'Order failed');
            }
        });

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        }

        loadProducts();
    </script>
</body>
</html>
